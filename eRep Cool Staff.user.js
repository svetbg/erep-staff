// ==UserScript==
// @name         eRep Cool Staff
// @include      *www.erepublik.com*
// @version      0.2.5
// @author       SvetBG
// @grant        none
// ==/UserScript==
/* jshint -W097 */
'use strict';
function init(){return bId?void $.ajax({url:"/"+LANG+"/military/nbp-stats/"+bId+"/2"}).success(function(t){parseBattleInfo(t)}):!1}function getRegion(){return $("a#region_name_link").html()}function setTitle(t){document.title=t+" | "+getRegion()}function getDominationPoints(){return dominationPoints}function setDominationPoints(t){dominationPoints=t}function parseBattleInfo(t){var e=jQuery.parseJSON(t);if(void 0===e||void 0===e.stats)return console.log("No stats!"),!1;var n=e.stats.current;if(!n)return console.log("No stats!"),!1;for(var o=e.division,i=o.domination,r=e.battle_zone_situation,a=[],l=[],s=[],d=1;5>d;d++){var c=parseFloat(i[d]).toFixed(2);invert?(a[d]=prettyDecimal(100-c),l[d]=c):(a[d]=c,l[d]=prettyDecimal(100-c));var u="#FC4444",p="#5178ED",g=prettyDecimal(a[d],2)>50?p:u,f=2==r[d]?"#EEC164":1==r[d]?"#90744F":"";epicChange[d]=epicChange[d]||0,epicChange[d]!=r[d]&&(console.log("Div "+d+" battle went from "+epicChange[d]+" to "+r[d]),console.log("Div "+d+" total dmg is: "+(battles[bId][currentZoneId][leftBattleId][d]+battles[bId][currentZoneId][rightBattleId][d]||0).toLocaleString()),epicChange[d]=r[d]),s[d]='<strong style="padding: 2px 0 2px 2px; border-right: 1px solid white; text-align: left; width: 33%; display: inline-block; color: '+p+'">'+o[leftBattleId][d].domination+'</strong>  <i style="padding: 2px 0; width: 17%; display: inline-block; text-align: center; font-size: 11px; font-weight: 900; color: '+g+"; background-color: "+f+'">'+prettyDecimal(a[d],0)+'</i>  <strong style="padding: 2px 2px 2px 0; border-left: 1px solid white; text-align: right; width: 33%; display: inline-block; color: '+u+'">'+o[rightBattleId][d].domination+"</strong>"}$(document).prop("title",a[fighterDivision]+" | "+getRegion());var v="",h=0,b=0,I=115,m=30,y=110;$(s).each(function(t,e){if(1>t)return!0;var n=parseInt(o[leftBattleId][t].domination)>=1800||parseInt(o[rightBattleId][t].domination)>=1800?" background-color: #979EA1; ":"";3>t?(h=(t-1)*I,v+='<div class="div_'+t+'" style="position: absolute; left: '+h+"px; top: "+m+"px; border: 1px solid white; width: "+y+"px;"+n+'; border-radius: 3px;">'+e+"</div>"):t>2&&(b=Math.abs(t-4)*I,v+='<div class="div_'+t+'" style="position: absolute; right: '+b+"px; top: "+m+"px; border: 1px solid white; width: "+y+"px;"+n+'; border-radius: 3px;">'+e+"</div>")}),v+='<div style="clear: both"><!-- need --></div>',$("div.domination-info").fadeOut("fast"),$("div.domination-info").html(v),$("div.domination-info").fadeIn("fast")}function prettyDecimal(t,e){return e="undefined"!=typeof e?e:2,parseFloat(t).toFixed(e)}function s(){if(null!=huntProduct)return clearInterval(huntProduct),huntProduct=null,!1;c();var t=parseInt($("#desired_interval").val())>0?1e3*parseInt($("#desired_interval").val()):3e5;huntProduct=setInterval(c,t)}function i(){var t=$("div.country-select"),e=parseInt("F0",17)>Math.pow(2,7)&&1==smart?"":"disabled";t.after('<div><a class="std_global_btn smallSize blueColor buyOffer" id="startHunting" style="width: 120px; padding: 0px 0px 7px 10px; margin-right: 5px;">Start Hunting</a> Price: <input id="desired_price" style="width: 70px;" class="shadowed buyField ng-pristine ng-valid ng-isolate-scope ng-valid-maxlength ng-touched"/> Qty: <input id="desired_qty" style="width: 70px;" class="shadowed buyField ng-pristine ng-valid ng-isolate-scope ng-valid-maxlength ng-touched"/> Interval: <select id="desired_interval" style="width: 70px; height: auto" class="shadowed buyField ng-pristine ng-valid ng-isolate-scope ng-valid-maxlength ng-touched"><option '+e+' value="3">3 sec</option><option '+e+' value="5">5 sec</option><option '+e+' value="10">10 sec</option><option '+e+' value="30">30 sec</option><option '+e+' value="60">60 sec</option><option value="300" selected>5 min</option></select></div>')}function g(){return location.hash.substr(1)}function c(){var t=g().split("/"),e=t[1],n=t[0],o=t[2],i=parseFloat($("#desired_price").val())||0,r=parseFloat($("#desired_qty").val())||0;$.ajax({url:"/"+LANG+"/economy/marketplace?countryId="+n+"&industryId="+e+"&quality="+o+"&orderBy=price_asc&currentPage=1&ajaxMarket=1"}).success(function(t){var e=$.parseJSON(t),n=0;$(e).each(function(t,e){setTimeout(function(){var t=parseFloat(e.priceWithTaxes);if(t>i)return console.log("Price is not good: "+t),!1;if(1>r)return console.log("Qty is 0"),!1;var n=r,o=e.id,a=parseInt(e.amount)>n?n:parseInt(e.amount),l=$("#award_token").val(),s={amount:a,offerId:o,buyAction:1,_token:l,orderBy:"price_asc",currentPage:1};$.ajax({type:"POST",url:"/"+LANG+"/economy/marketplace",data:s}).success(function(e){var n=JSON.parse(e);if(n.error!==!1)return console.log(e),console.log("There was an error buying the product!"),!1;var o=r-a;console.log("Bought "+a+" pieces at "+t),0>=o&&(console.log("Bought all amount wanted. Stop hunting!"),$("#startHunting").trigger("click"),o=0),r=o,$("#desired_qty").val(o)})},n+150),n+=150})})}function refreshData(){var t=30;init(),setTimeout(refreshData,1e3*t)}function fightFirst(){if(!$("em#time_until span").html())return!1;var t=$("em#time_until span").html().trim(),e=($("#fight_btn"),5);if("00:00"==t){clearInterval(battle_start_check_interval);var n=0,o=setInterval(function(){console.log("Fight "+n+"!"),n++,n==e&&clearInterval(o)},parseInt("1F4",16))}else console.log(t)}function getBlueDomination(){return $("#blue_domination").val()}function he(){if("undefined"==typeof reset_health_to_recover||"undefined"==typeof globalNS.userInfo.wellness||"undefined"==typeof globalNS.userInfo.energyPerInterval)return!1;var t=2*reset_health_to_recover-globalNS.userInfo.wellness,e=t/(10*globalNS.userInfo.energyPerInterval)-(.1-new_date/3600),n=Math.floor(e),o=parseInt(e%n*100*60/100);setTimeout(function(){st(n,o)},1e3),setInterval(function(){o=0==o?59:o-1,n=59==o?n-1:n,st(n,o)},6e4)}function st(t,e){1==e.toString().length&&(e="0"+e);var n=$("#ecsuh");n.html('<div><strong style="color: #666; float: left;">Time to full health: </strong><span style="float: right">'+t+":"+e+"</span></div>")}var LANG="en";"undefined"!=typeof erepublik&&(LANG=erepublik.settings.culture);var bId=SERVER_DATA.battleId,currentZoneId=SERVER_DATA.zoneId,countryId=SERVER_DATA.countryId,invert=SERVER_DATA.mustInvert,fighterDivision=SERVER_DATA.division,$=jQuery,dominationPoints=0,epicChange=[],smart=!1,huntProduct=null,container=$("div.clock_holder");container.after('<div class="domination-info" style="color: white; display: block; font-size: 13px;"></div>');var battles={},battle_start_check_interval="";$(document).ready(function(){if($("div.user_section").after('<div id="ecsuh" style="font: bold 11px arial;padding: 0 0 7px; float: left; margin: 0; width: 155px; border-bottom: 1px solid #dfdfdf;"></div>'),refreshData(),i(),$("#startHunting").click(function(t){var e="Start Hunting"==$(this).html()?"Stop Hunting":"Start Hunting";$(this).html(e),s()}),he(),"undefined"!=typeof pomelo){battles=JSON.parse(localStorage.getItem("eS_BATTLE"+bId))||{},battles[bId]=battles[bId]||{},battles[bId][currentZoneId]=battles[bId][currentZoneId]||{},pomelo.on("onMessage",function(t){var e=parseInt(t.division),n=parseInt(t.side),o=parseInt(t.msg.damage);battles[bId][currentZoneId][n]=battles[bId][currentZoneId][n]||{},battles[bId][currentZoneId][n][e]=battles[bId][currentZoneId][n][e]||0,battles[bId][currentZoneId][n][e]+=o,1==!smart&&parseInt("F0",17)<=Math.pow(2,7)&&localStorage.setItem("eS_BATTLE"+bId,JSON.stringify(battles)),n==leftBattleId&&e==fighterDivision}),pomelo.on("onError",function(t){console.log("Error"),console.log(t)}),pomelo.on("onAdd",function(t){console.log("onAdd"),console.log(t)});var t=$("div#pvp");t.after('<div class="div_dmg_left" style="width:150px;position:absolute;top:0px;z-index:350;left:-180px;color:black;"></div>'),t.after('<div class="div_dmg_right" style="width:150px;position:absolute;top:0px;right:-165px;z-index:350;color:black;"></div>'),setInterval(function(){for(var t="",e="",n=1;5>n;n++)t+="Div"+n+": "+(battles[bId][currentZoneId][leftBattleId]&&battles[bId][currentZoneId][leftBattleId][n]||0).toLocaleString()+"<br />",e+="Div"+n+": "+(battles[bId][currentZoneId][rightBattleId]&&battles[bId][currentZoneId][rightBattleId][n]||0).toLocaleString()+"<br />";$(".div_dmg_left").html(t),$(".div_dmg_right").html(e),1==smart&&parseInt("F0",17)<=Math.pow(2,8)&&localStorage.setItem("eS_BATTLE"+bId,JSON.stringify(battles))},1e3),battle_start_check_interval=setInterval(fightFirst,500)}});
